# 🏗 Архитектура Telegram бота LEVEL FIT

## 📐 Схема работы

```
┌─────────────────────────────────────────────────────────────────────┐
│                           ПОЛЬЗОВАТЕЛЬ                              │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        САЙТ LEVEL FIT                               │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Тарифы:                                                      │  │
│  │  • ЛАЙТ ($39)      [ВЫБРАТЬ ТАРИФ] ──────────────┐           │  │
│  │  • СТАРТ ($69)     [ВЫБРАТЬ ТАРИФ] ──────────────┤           │  │
│  │  • ОПТИМА ($119)   [ВЫБРАТЬ ТАРИФ] ──────────────┤           │  │
│  │  • VIP ($299)      [ВЫБРАТЬ ТАРИФ] ──────────────┤           │  │
│  └──────────────────────────────────────────────────┼───────────┘  │
└─────────────────────────────────────────────────────┼──────────────┘
                                                       │
                                  https://t.me/bot?start=plan
                                                       │
                                                       ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       TELEGRAM BOT                                  │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  1. Приветствие с выбранным тарифом                          │  │
│  │  2. Показ деталей: цена, описание, скидка                    │  │
│  │  3. Кнопка "💳 Оплатить"                                      │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    TELEGRAM PAYMENTS API                            │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  • Отправка инвойса                                           │  │
│  │  • Форма ввода данных карты                                   │  │
│  │  • Безопасная обработка платежа                               │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│              ПЛАТЕЖНЫЙ ПРОВАЙДЕР                                    │
│              (YooKassa / ЮMoney / Stripe)                          │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  • Обработка транзакции                                       │  │
│  │  • 3D-Secure (если требуется)                                 │  │
│  │  • Списание средств                                           │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
                    ▼                             ▼
        ┌──────────────────────┐      ┌─────────────────────┐
        │   ПОЛЬЗОВАТЕЛЬ       │      │   АДМИНИСТРАТОР     │
        │                      │      │                     │
        │  ✅ Подтверждение   │      │  📧 Уведомление:    │
        │  🎉 Активация       │      │  • Новая подписка   │
        │  📋 Инструкции      │      │  • Контакты клиента │
        │  💪 Добро пожаловать│      │  • Сумма платежа    │
        └──────────────────────┘      └─────────────────────┘
```

## 🔄 Жизненный цикл платежа

### 1️⃣ Инициация

```python
# Пользователь нажимает кнопку на сайте
Website Button Click → Opens Telegram → Bot receives /start command
```

**Параметры:**
- URL: `https://t.me/bot_username?start=plan_id`
- plan_id: `light`, `start`, `optimal`, `vip`

### 2️⃣ Отображение тарифа

```python
@dp.message(Command("start"))
async def cmd_start(message):
    plan_id = extract_from_message(message)
    await show_plan_details(message, plan_id)
```

**Что показывается:**
- Название тарифа
- Описание услуг
- Старая и новая цена
- Процент скидки
- Кнопка "Оплатить"

### 3️⃣ Создание инвойса

```python
@dp.callback_query(F.data.startswith("pay_"))
async def process_payment(callback):
    await bot.send_invoice(
        chat_id=user_id,
        title=f"LEVEL FIT - {plan['name']}",
        prices=[LabeledPrice(label=..., amount=...)],
        provider_token=PAYMENT_TOKEN,
        # ...
    )
```

### 4️⃣ Pre-checkout

```python
@dp.pre_checkout_query()
async def process_pre_checkout_query(pre_checkout_query):
    # Здесь можно добавить дополнительные проверки
    # Например, проверить наличие подписки
    await bot.answer_pre_checkout_query(pre_checkout_query.id, ok=True)
```

### 5️⃣ Успешный платеж

```python
@dp.message(F.successful_payment)
async def process_successful_payment(message):
    # Сохранить в БД
    # Отправить подтверждение
    # Уведомить админа
    # Активировать подписку
```

## 📊 Структура данных

### Тариф (Plan)

```python
{
    'name': str,          # Название тарифа
    'price': int,         # Цена в долларах
    'old_price': int,     # Старая цена
    'currency': str,      # Валюта
    'description': str,   # Описание услуг
    'emoji': str,         # Эмодзи для визуала
    'recommended': bool   # Рекомендуемый?
}
```

### Платеж (Payment)

```python
{
    'user_id': int,           # Telegram ID
    'plan_id': str,           # ID тарифа
    'amount': int,            # Сумма
    'currency': str,          # Валюта
    'name': str,              # Имя клиента
    'email': str,             # Email
    'phone': str,             # Телефон
    'timestamp': datetime,    # Время платежа
    'status': str            # pending/success/failed
}
```

## 🗂 Структура файлов

```
bot/
├── bot.py                      # Основной файл бота
├── requirements.txt            # Python зависимости
├── .env                        # Переменные окружения (НЕ коммитить!)
├── .gitignore                 # Игнорируемые файлы
│
├── README.md                   # Общая документация
├── SETUP.md                    # Пошаговая настройка
├── DEPLOYMENT.md               # Инструкции по деплою
├── ARCHITECTURE.md             # Этот файл
│
├── levelfit-bot.service       # Systemd сервис
├── Dockerfile                  # Docker образ
└── docker-compose.yml          # Docker Compose конфигурация
```

## 🔐 Безопасность

### Токены и ключи

```
.env (НЕ в Git!)
├── BOT_TOKEN           # Токен бота от @BotFather
├── PAYMENT_TOKEN       # Токен платежного провайдера
└── ADMIN_TELEGRAM_ID   # ID администратора
```

### Валидация

1. **Pre-checkout проверки:**
   - Проверка суммы платежа
   - Проверка валюты
   - Проверка существования тарифа
   - (Опционально) Проверка наличия активной подписки

2. **Успешный платеж:**
   - Проверка подписи от Telegram
   - Сохранение в БД (если используется)
   - Уведомление админа

### Защита данных

- Все токены в `.env` файле
- `.env` в `.gitignore`
- Никаких чувствительных данных в коде
- HTTPS для webhook (если используется)

## 🚀 Масштабирование

### Текущая архитектура (до 1000 пользователей)

```
[Бот] → [Telegram API] → [Платежный провайдер]
```

### Средняя нагрузка (1000-10000 пользователей)

```
[Бот] → [Redis кэш] → [PostgreSQL БД]
                ↓
        [Telegram API] → [Платежный провайдер]
```

### Высокая нагрузка (10000+ пользователей)

```
                    ┌─ [Бот инстанс 1] ─┐
[Load Balancer] ────┼─ [Бот инстанс 2] ─┼──→ [Redis кэш]
                    └─ [Бот инстанс 3] ─┘         ↓
                                            [PostgreSQL]
                                                  ↓
                                          [Telegram API]
                                                  ↓
                                      [Платежный провайдер]
```

## 📈 Будущие улучшения

### Фаза 1 (MVP) ✅
- [x] Базовая обработка платежей
- [x] Уведомления админу
- [x] Выбор тарифа с сайта

### Фаза 2
- [ ] База данных для хранения подписок
- [ ] Автоматическое продление подписок
- [ ] Реферальная система
- [ ] Промокоды и скидки

### Фаза 3
- [ ] Личный кабинет в боте
- [ ] История платежей
- [ ] Чат с тренером в боте
- [ ] Напоминания о тренировках

### Фаза 4
- [ ] Интеграция с CRM
- [ ] Аналитика и метрики
- [ ] A/B тестирование
- [ ] Webhook вместо polling

## 🔧 Технологии

| Компонент | Технология | Версия |
|-----------|-----------|--------|
| Язык | Python | 3.11+ |
| Бот фреймворк | aiogram | 3.3.0 |
| HTTP клиент | aiohttp | 3.9.1 |
| Env vars | python-dotenv | 1.0.0 |
| Telegram API | Bot API | Latest |
| Payments | YooKassa/Stripe | Latest |

## 📞 API Endpoints

### Telegram Bot API

```
GET /bot<token>/getMe
GET /bot<token>/getUpdates
POST /bot<token>/sendMessage
POST /bot<token>/sendInvoice
POST /bot<token>/answerPreCheckoutQuery
```

### Платежный провайдер (YooKassa)

```
POST /v3/payments
GET /v3/payments/{payment_id}
POST /v3/refunds
```

## 🧪 Тестирование

### Тестовые карты

**YooKassa:**
- ✅ Успешный: `5555 5555 5555 4477`
- ❌ Отклонен: `5555 5555 5555 4444`
- ⏳ 3DS: `5555 5555 5555 5599`

**Stripe:**
- ✅ Успешный: `4242 4242 4242 4242`
- ❌ Отклонен: `4000 0000 0000 0002`

### Unit тесты (TODO)

```python
tests/
├── test_bot.py           # Тесты бота
├── test_payments.py      # Тесты платежей
└── test_handlers.py      # Тесты обработчиков
```

---

**Документация актуальна на:** Декабрь 2024

